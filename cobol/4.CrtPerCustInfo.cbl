IDENTIFICATION DIVISION.
PROGRAM-ID. CRTPERC02.

ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.

DATA DIVISION.
WORKING-STORAGE SECTION.
01  SQLCA.
    05  SQLCODE            PIC S9(9) COMP-4.

01  WS-RESP-CODE           PIC X(06).
01  WS-RESP-MSG            PIC X(50).
01  WS-CUST-COUNT          PIC 9(5).
01  WS-GENERATED-CUST-NO   PIC X(10).
01  WS-CURRENT-DATE        PIC X(08).
01  WS-CURRENT-TIME        PIC X(06).

*> 客户基本信息工作区
01  WS-CUST-BASIC-INFO.
    05  WS-TENANT-NO       PIC X(10) VALUE '001'.
    05  WS-CUST-NO         PIC X(10).
    05  WS-CUST-TYP-CD     PIC X(01) VALUE '0'.
    05  WS-CUST-LVL-CD     PIC X(02) VALUE '1'.
    05  WS-CRTF-TYP-CD     PIC X(02).
    05  WS-CRTF-NO         PIC X(20).
    05  WS-CUST-NM         PIC X(50).
    05  WS-CRTF-GRANT-DT   PIC X(10). *> yyyy-mm-dd
    05  WS-CRTF-MATR-DT    PIC X(10). *> yyyy-mm-dd
    05  WS-STATE-RGN-CD    PIC X(02).
    05  WS-ADDR            PIC X(100).
    05  WS-RSVD-MOBILE-NO  PIC X(15).
    05  WS-EMPLY-FLG       PIC X(01).
    05  WS-VALID-FLG       PIC X(01) VALUE '1'.
    05  WS-CRT-TELR-NO     PIC X(10).
    05  WS-UPD-TELR-NO     PIC X(10).

*> 个人客户信息工作区  
01  WS-PER-CUST-INFO.
    05  WS-PER-TENANT-NO   PIC X(10) VALUE '001'.
    05  WS-PER-CUST-NO     PIC X(10).
    05  WS-PER-GENDER-CD   PIC X(01).
    05  WS-PER-CAREER-CD   PIC X(02).
    05  WS-PER-ADMIN-CD    PIC X(06).
    05  WS-PER-VALID-FLG   PIC X(01) VALUE '1'.
    05  WS-PER-CRT-TELR-NO PIC X(10).
    05  WS-PER-UPD-TELR-NO PIC X(10).

LINKAGE SECTION.
*> ========== 输入参数 ==========
01  REQ-CRTF-TYP-CD        PIC X(02).     *> 证件类型代码
01  REQ-CRTF-NO            PIC X(20).     *> 证件号码
01  REQ-CUST-NM            PIC X(50).     *> 客户名称
01  REQ-GENDER-CD          PIC X(01).     *> 性别代码
01  REQ-STATE-RGN-CD       PIC X(02).     *> 国家和地区代码
01  REQ-CRTF-GRANT-DT      PIC X(10).     *> 证件发放日期 yyyy-mm-dd
01  REQ-CRTF-MATR-DT       PIC X(10).     *> 证件到期日期 yyyy-mm-dd
01  REQ-CAREER-TYP-CD      PIC X(02).     *> 职业类型代码
01  REQ-ADDR               PIC X(100).    *> 地址
01  REQ-RSVD-MOBILE-NO     PIC X(15).     *> 预留手机号码
01  REQ-ADMIN-CMPRMNT-CD   PIC X(06).     *> 行政区划代码
01  REQ-EMPLY-FLG          PIC X(01).     *> 员工标志
01  REQ-PASS-CRTF-NO       PIC X(20).     *> 通行证证件号码
01  REQ-RENEWAL-TMS        PIC 9(02).     *> 换证次数
01  REQ-OPER-TELR-NO       PIC X(10).     *> 操作柜员号

*> ========== 输出参数 ==========
01  RESP-CODE              PIC X(06).
01  RESP-MSG               PIC X(50).
01  RESP-CUST-NO           PIC X(10).     *> 生成的客户号

PROCEDURE DIVISION 
    USING REQ-CRTF-TYP-CD, REQ-CRTF-NO, REQ-CUST-NM,
          REQ-GENDER-CD, REQ-STATE-RGN-CD, REQ-CRTF-GRANT-DT,
          REQ-CRTF-MATR-DT, REQ-CAREER-TYP-CD, REQ-ADDR,
          REQ-RSVD-MOBILE-NO, REQ-ADMIN-CMPRMNT-CD, REQ-EMPLY-FLG,
          REQ-PASS-CRTF-NO, REQ-RENEWAL-TMS, REQ-OPER-TELR-NO,
          RESP-CODE, RESP-MSG, RESP-CUST-NO.

MAIN-LOGIC.
    *> 初始化
    MOVE 'E99999' TO WS-RESP-CODE
    MOVE 'PROCESSING ERROR' TO WS-RESP-MSG
    MOVE SPACES TO RESP-CUST-NO

    *> 1) 参数基础校验 - 所有必填字段
    PERFORM VALIDATE-REQUIRED-FIELDS.
    IF WS-RESP-CODE NOT = '000000'
       GO TO EXIT-PROGRAM
    END-IF.

    *> 2) 检查客户是否已存在
    EXEC SQL
        SELECT COUNT(*)
          INTO :WS-CUST-COUNT
          FROM CUSTOMER_BASIC_INFO
         WHERE CRTF_TYP_CD = :REQ-CRTF-TYP-CD
           AND CRTF_NO = :REQ-CRTF-NO
           AND VALID_FLG = '1'
    END-EXEC.

    IF SQLCODE = 0 AND WS-CUST-COUNT > 0
       MOVE 'F20006' TO WS-RESP-CODE
       MOVE '客户已存在' TO WS-RESP-MSG
       GO TO EXIT-PROGRAM
    END-IF.

    *> 3) 开始事务
    EXEC SQL START TRANSACTION END-EXEC
    IF SQLCODE NOT = 0
       MOVE 'E12001' TO WS-RESP-CODE
       MOVE '事务启动失败' TO WS-RESP-MSG
       GO TO EXIT-PROGRAM
    END-IF.

    *> 4) 生成客户号
    PERFORM GENERATE-CUST-NO.

    *> 5) 设置客户基本信息
    MOVE REQ-CRTF-TYP-CD TO WS-CRTF-TYP-CD
    MOVE REQ-CRTF-NO TO WS-CRTF-NO
    MOVE REQ-CUST-NM TO WS-CUST-NM
    MOVE REQ-STATE-RGN-CD TO WS-STATE-RGN-CD
    MOVE REQ-CRTF-GRANT-DT TO WS-CRTF-GRANT-DT
    MOVE REQ-CRTF-MATR-DT TO WS-CRTF-MATR-DT
    MOVE REQ-ADDR TO WS-ADDR
    MOVE REQ-RSVD-MOBILE-NO TO WS-RSVD-MOBILE-NO
    MOVE REQ-EMPLY-FLG TO WS-EMPLY-FLG
    MOVE REQ-OPER-TELR-NO TO WS-CRT-TELR-NO
    MOVE REQ-OPER-TELR-NO TO WS-UPD-TELR-NO

    *> 6) 设置个人客户信息
    MOVE WS-CUST-NO TO WS-PER-CUST-NO
    MOVE REQ-GENDER-CD TO WS-PER-GENDER-CD
    MOVE REQ-CAREER-TYP-CD TO WS-PER-CAREER-CD
    MOVE REQ-ADMIN-CMPRMNT-CD TO WS-PER-ADMIN-CD
    MOVE REQ-OPER-TELR-NO TO WS-PER-CRT-TELR-NO
    MOVE REQ-OPER-TELR-NO TO WS-PER-UPD-TELR-NO

    *> 7) 插入客户基本信息
    EXEC SQL
        INSERT INTO CUSTOMER_BASIC_INFO (
            TENANT_NO, CUST_NO, CUST_TYP_CD, CUST_LVL_CD,
            CRTF_TYP_CD, CRTF_NO, CUST_NM, CRTF_GRANT_DT,
            CRTF_MATR_DT, STATE_AND_RGN_CD, ADDR, RSVD_MOBILE_NO,
            EMPLY_FLG, VALID_FLG, CRT_TELR_NO, UPD_TELR_NO,
            CRT_TM, UPD_TM
        ) VALUES (
            :WS-TENANT-NO, :WS-CUST-NO, :WS-CUST-TYP-CD, :WS-CUST-LVL-CD,
            :WS-CRTF-TYP-CD, :WS-CRTF-NO, :WS-CUST-NM, :WS-CRTF-GRANT-DT,
            :WS-CRTF-MATR-DT, :WS-STATE-RGN-CD, :WS-ADDR, :WS-RSVD-MOBILE-NO,
            :WS-EMPLY-FLG, :WS-VALID-FLG, :WS-CRT-TELR-NO, :WS-UPD-TELR-NO,
            CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
        )
    END-EXEC.

    IF SQLCODE NOT = 0
       MOVE 'E12002' TO WS-RESP-CODE
       MOVE '插入客户基本信息失败' TO WS-RESP-MSG
       EXEC SQL ROLLBACK END-EXEC
       GO TO EXIT-PROGRAM
    END-IF.

    *> 8) 插入个人客户信息
    EXEC SQL
        INSERT INTO PERSONAL_CUSTOMER_INFO (
            TENANT_NO, CUST_NO, GENDER_CD, CAREER_TYP_CD,
            ADMIN_CMPRMNT_CD, VALID_FLG, CRT_TELR_NO, UPD_TELR_NO,
            CRT_TM, UPD_TM
        ) VALUES (
            :WS-PER-TENANT-NO, :WS-PER-CUST-NO, :WS-PER-GENDER-CD, 
            :WS-PER-CAREER-CD, :WS-PER-ADMIN-CD, :WS-PER-VALID-FLG,
            :WS-PER-CRT-TELR-NO, :WS-PER-UPD-TELR-NO, 
            CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
        )
    END-EXEC.

    IF SQLCODE NOT = 0
       MOVE 'E12003' TO WS-RESP-CODE
       MOVE '插入个人客户信息失败' TO WS-RESP-MSG
       EXEC SQL ROLLBACK END-EXEC
       GO TO EXIT-PROGRAM
    END-IF.

    *> 9) 提交事务
    EXEC SQL COMMIT END-EXEC
    IF SQLCODE NOT = 0
       MOVE 'E12004' TO WS-RESP-CODE
       MOVE '事务提交失败' TO WS-RESP-MSG
       EXEC SQL ROLLBACK END-EXEC
       GO TO EXIT-PROGRAM
    END-IF.

    *> 10) 成功返回
    MOVE WS-CUST-NO TO RESP-CUST-NO
    MOVE '000000' TO WS-RESP-CODE
    MOVE '客户信息开立成功' TO WS-RESP-MSG.

EXIT-PROGRAM.
    MOVE WS-RESP-CODE TO RESP-CODE
    MOVE WS-RESP-MSG TO RESP-MSG
    EXIT PROGRAM.

*> 参数校验子程序
VALIDATE-REQUIRED-FIELDS.
    IF REQ-CRTF-TYP-CD = SPACES 
       MOVE 'F20001' TO WS-RESP-CODE
       MOVE '证件类型代码不能为空' TO WS-RESP-MSG
       EXIT PROGRAM
    END-IF.

    IF REQ-CRTF-NO = SPACES 
       MOVE 'F20002' TO WS-RESP-CODE
       MOVE '证件号码不能为空' TO WS-RESP-MSG
       EXIT PROGRAM
    END-IF.

    IF REQ-CUST-NM = SPACES 
       MOVE 'F20003' TO WS-RESP-CODE
       MOVE '客户名称不能为空' TO WS-RESP-MSG
       EXIT PROGRAM
    END-IF.

    IF REQ-GENDER-CD = SPACES 
       MOVE 'F20004' TO WS-RESP-CODE
       MOVE '性别代码不能为空' TO WS-RESP-MSG
       EXIT PROGRAM
    END-IF.

    IF REQ-STATE-RGN-CD = SPACES 
       MOVE 'F20005' TO WS-RESP-CODE
       MOVE '国家和地区代码不能为空' TO WS-RESP-MSG
       EXIT PROGRAM
    END-IF.

    IF REQ-CRTF-GRANT-DT = SPACES 
       MOVE 'F20006' TO WS-RESP-CODE
       MOVE '证件发放日期不能为空' TO WS-RESP-MSG
       EXIT PROGRAM
    END-IF.

    IF REQ-CRTF-MATR-DT = SPACES 
       MOVE 'F20007' TO WS-RESP-CODE
       MOVE '证件到期日期不能为空' TO WS-RESP-MSG
       EXIT PROGRAM
    END-IF.

    IF REQ-CAREER-TYP-CD = SPACES 
       MOVE 'F20008' TO WS-RESP-CODE
       MOVE '职业类型代码不能为空' TO WS-RESP-MSG
       EXIT PROGRAM
    END-IF.

    IF REQ-ADDR = SPACES 
       MOVE 'F20009' TO WS-RESP-CODE
       MOVE '地址不能为空' TO WS-RESP-MSG
       EXIT PROGRAM
    END-IF.

    IF REQ-RSVD-MOBILE-NO = SPACES 
       MOVE 'F20010' TO WS-RESP-CODE
       MOVE '预留手机号码不能为空' TO WS-RESP-MSG
       EXIT PROGRAM
    END-IF.

    MOVE '000000' TO WS-RESP-CODE.

*> 生成客户号子程序
GENERATE-CUST-NO.
    *> 使用序列生成客户号
    EXEC SQL
        SELECT 'CUST' || LPAD(NEXTVAL FOR CUST_NO_SEQ, 6, '0')
          INTO :WS-CUST-NO
          FROM SYSIBM.SYSDUMMY1
    END-EXEC.
    
    IF SQLCODE NOT = 0
       *> 如果序列不存在，使用时间戳生成
       MOVE FUNCTION CURRENT-DATE(1:8) TO WS-CURRENT-DATE
       MOVE FUNCTION CURRENT-TIME(1:6) TO WS-CURRENT-TIME
       STRING 'CUST' 
              WS-CURRENT-DATE(3:6)
              WS-CURRENT-TIME
         INTO WS-CUST-NO
       END-STRING
    END-IF.